```html
<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zadania Szachowe Pro</title>
<style>
:root {
  --board-light: #f0d9b5;
  --board-dark: #b58863;
  --primary: #81b64c;
  --primary-hover: #72a744;
  --accent: #ca3c3d;
  --text-dark: #312e2b;
  --text-light: #fff;
  --bg-light: #f7f7f7;
  --bg-white: #ffffff;
  --border: #dddddd;
  --shadow: 0 2px 10px rgba(0,0,0,0.1);
  --shadow-lg: 0 4px 20px rgba(0,0,0,0.15);
}

body.dark-mode {
  --text-dark: #e0e0e0;
  --text-light: #ffffff;
  --bg-light: #2d2d2d;
  --bg-white: #1a1a1a;
  --border: #404040;
}

body.theme-blue { --board-light: #dee3e6; --board-dark: #8ca2ad; }
body.theme-green { --board-light: #ffffdd; --board-dark: #86a666; }
body.theme-brown { --board-light: #f0dab5; --board-dark: #946f51; }

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-light);
  color: var(--text-dark);
  line-height: 1.6;
}

.header {
  background: var(--text-dark);
  color: var(--text-light);
  padding: 1rem 2rem;
  box-shadow: var(--shadow-lg);
  position: sticky;
  top: 0;
  z-index: 1000;
}

.header-content {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.logo {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-light);
  text-decoration: none;
}

.user-stats {
  display: flex;
  gap: 1.5rem;
  align-items: center;
  font-size: 0.9rem;
}

.stat-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.main-container {
  max-width: 1400px;
  margin: 2rem auto;
  padding: 0 2rem;
  display: grid;
  grid-template-columns: 1fr 400px;
  gap: 2rem;
}

.board-section {
  background: var(--bg-white);
  border-radius: 12px;
  padding: 2rem;
  box-shadow: var(--shadow);
}

.puzzle-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid var(--border);
  flex-wrap: wrap;
  gap: 1rem;
}

.puzzle-title h1 {
  font-size: 1.75rem;
  color: var(--text-dark);
}

.puzzle-meta {
  display: flex;
  gap: 1rem;
  align-items: center;
  flex-wrap: wrap;
}

.difficulty-badge {
  padding: 0.4rem 0.9rem;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
  text-transform: uppercase;
}

.difficulty-badge.easy { background: #d4edda; color: #155724; }
.difficulty-badge.medium { background: #fff3cd; color: #856404; }
.difficulty-badge.hard { background: #f8d7da; color: #721c24; }

.rating-badge {
  padding: 0.4rem 0.9rem;
  background: var(--primary);
  color: white;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
}

.puzzle-info {
  display: flex;
  gap: 1rem;
  align-items: center;
}

.timer, .moves-count {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: var(--bg-light);
  border-radius: 8px;
  font-weight: 600;
}

.board-container {
  display: flex;
  justify-content: center;
  margin: 2rem 0;
}

.board {
  display: grid;
  grid-template-columns: repeat(8, 70px);
  grid-template-rows: repeat(8, 70px);
  border: 3px solid var(--text-dark);
  box-shadow: var(--shadow-lg);
}

.square {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
}

.square.light { background: var(--board-light); }
.square.dark { background: var(--board-dark); }

.square.selected {
  box-shadow: inset 0 0 0 3px var(--primary);
  z-index: 10;
}

.square.legal-move::after {
  content: '';
  position: absolute;
  width: 25%;
  height: 25%;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 50%;
}

.square.last-move {
  background-color: rgba(155, 199, 0, 0.4) !important;
}

.piece {
  font-size: 56px;
  cursor: grab;
  user-select: none;
  transition: transform 0.1s ease;
  filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.3));
}

.piece:active {
  cursor: grabbing;
  transform: scale(1.1);
}

.controls {
  display: flex;
  gap: 1rem;
  margin-top: 2rem;
  flex-wrap: wrap;
  justify-content: center;
}

.btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  color: white;
  box-shadow: var(--shadow);
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.btn-primary { background: var(--primary); }
.btn-primary:hover { background: var(--primary-hover); }
.btn-secondary { background: #6c757d; }
.btn-secondary:hover { background: #5a6268; }
.btn-success { background: #28a745; }
.btn-info { background: #5bc0de; }

.sidebar {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.panel {
  background: var(--bg-white);
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: var(--shadow);
}

.panel-header {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: 1rem;
  color: var(--text-dark);
}

.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-top: 1rem;
}

.stat-card {
  background: var(--bg-light);
  padding: 1rem;
  border-radius: 8px;
  text-align: center;
}

.stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary);
}

.stat-label {
  font-size: 0.85rem;
  color: #666;
  margin-top: 0.25rem;
}

.moves-list {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 0.5rem;
}

.move-item {
  display: flex;
  padding: 0.5rem;
  border-radius: 6px;
  margin-bottom: 0.25rem;
  cursor: pointer;
}

.move-item:hover {
  background: var(--bg-light);
}

.move-notation {
  font-family: 'Courier New', monospace;
  font-weight: 600;
  margin-left: 0.5rem;
}

.theme-selector, .piece-selector {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin: 1rem 0;
}

.theme-option, .piece-option {
  width: 50px;
  height: 50px;
  border-radius: 6px;
  cursor: pointer;
  border: 3px solid transparent;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.theme-option:hover, .piece-option:hover {
  transform: scale(1.1);
}

.theme-option.active, .piece-option.active {
  border-color: var(--primary);
}

.theme-classic { background: linear-gradient(135deg, #f0d9b5 50%, #b58863 50%); }
.theme-blue { background: linear-gradient(135deg, #dee3e6 50%, #8ca2ad 50%); }
.theme-green { background: linear-gradient(135deg, #ffffdd 50%, #86a666 50%); }
.theme-brown { background: linear-gradient(135deg, #f0dab5 50%, #946f51 50%); }

.setting-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 0;
  border-bottom: 1px solid var(--border);
}

.setting-item:last-child {
  border-bottom: none;
}

.toggle-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 26px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: 0.4s;
  border-radius: 26px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: 0.4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: var(--primary);
}

input:checked + .slider:before {
  transform: translateX(24px);
}

.feedback {
  position: fixed;
  top: 80px;
  right: 20px;
  padding: 1rem 1.5rem;
  border-radius: 8px;
  font-weight: 600;
  box-shadow: var(--shadow-lg);
  display: none;
  align-items: center;
  gap: 0.75rem;
  z-index: 1001;
}

.feedback.visible { display: flex; }
.feedback.success { background: #28a745; color: white; }
.feedback.error { background: var(--accent); color: white; }
.feedback.info { background: #5bc0de; color: white; }

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 2000;
  align-items: center;
  justify-content: center;
}

.modal.visible { display: flex; }

.modal-content {
  background: var(--bg-white);
  padding: 2.5rem;
  border-radius: 16px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  text-align: center;
}

.modal-title {
  font-size: 2rem;
  font-weight: 700;
  margin: 1rem 0;
  color: var(--text-dark);
}

.modal-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  background: var(--bg-light);
  padding: 1.5rem;
  border-radius: 8px;
  margin: 1.5rem 0;
}

.modal-stat-value {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--primary);
}

.modal-actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
  margin-top: 2rem;
}

@media (max-width: 1200px) {
  .main-container {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .board {
    grid-template-columns: repeat(8, 50px);
    grid-template-rows: repeat(8, 50px);
  }
  .piece { font-size: 40px; }
  .main-container { padding: 0 1rem; }
}
</style>
</head>
<body>

<header class="header">
  <div class="header-content">
    <a href="#" class="logo">
      <span>‚ôü</span>
      <span>Zadania Szachowe Pro</span>
    </a>
    <div class="user-stats">
      <div class="stat-item">
        <span>üèÜ</span>
        <span id="userRating">1200</span>
      </div>
      <div class="stat-item">
        <span>üî•</span>
        <span id="userStreak">0</span>
      </div>
    </div>
  </div>
</header>

<div class="main-container">
  
  <div class="board-section">
    
    <div class="puzzle-header">
      <div class="puzzle-title">
        <h1 id="puzzleTitle">Zadanie Taktyczne</h1>
        <div class="puzzle-meta">
          <span class="difficulty-badge easy" id="difficultyBadge">
            <span id="difficultyText">≈Åatwy</span>
          </span>
          <span class="rating-badge" id="ratingBadge">
            <span id="puzzleRating">1200</span>
          </span>
        </div>
      </div>
      
      <div class="puzzle-info">
        <div class="timer">
          <span>‚è±Ô∏è</span>
          <span id="timerDisplay">0:00</span>
        </div>
        <div class="moves-count">
          <span>üéØ</span>
          <span><span id="currentMove">0</span>/<span id="totalMoves">0</span></span>
        </div>
      </div>
    </div>
    
    <div class="board-container">
      <div id="chessBoard" class="board"></div>
    </div>
    
    <div class="controls">
      <button class="btn btn-primary" onclick="showHint()">
        <span>üí°</span>
        <span>Podpowied≈∫</span>
      </button>
      <button class="btn btn-secondary" onclick="resetPuzzle()">
        <span>üîÑ</span>
        <span>Reset</span>
      </button>
      <button class="btn btn-secondary" onclick="undoMove()">
        <span>‚Ü∂</span>
        <span>Cofnij</span>
      </button>
      <button class="btn btn-success" onclick="nextPuzzle()">
        <span>‚Üí</span>
        <span>Nastƒôpne</span>
      </button>
    </div>
    
  </div>
  
  <div class="sidebar">
    
    <div class="panel">
      <h2 class="panel-header">üìä Tw√≥j Postƒôp</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalSolved">0</div>
          <div class="stat-label">RozwiƒÖzane</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="bestStreak">0</div>
          <div class="stat-label">Najlepsza passa</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="accuracyPercent">0</div>
          <div class="stat-label">Celno≈õƒá %</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="averageTime">0:00</div>
          <div class="stat-label">≈ör. czas</div>
        </div>
      </div>
    </div>
    
    <div class="panel">
      <h2 class="panel-header">üìù Historia Ruch√≥w</h2>
      <div class="moves-list" id="movesList">
        <div style="text-align: center; color: #999; padding: 2rem;">
          Brak ruch√≥w
        </div>
      </div>
    </div>
    
    <div class="panel">
      <h2 class="panel-header">‚öôÔ∏è Ustawienia</h2>
      
      <div class="setting-item">
        <span>Tryb ciemny</span>
        <label class="toggle-switch">
          <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
          <span class="slider"></span>
        </label>
      </div>
      
      <div style="margin-top: 1rem;">
        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Motyw szachownicy</label>
        <div class="theme-selector">
          <div class="theme-option theme-classic active" onclick="changeTheme('classic')"></div>
          <div class="theme-option theme-blue" onclick="changeTheme('blue')"></div>
          <div class="theme-option theme-green" onclick="changeTheme('green')"></div>
          <div class="theme-option theme-brown" onclick="changeTheme('brown')"></div>
        </div>
      </div>
      
      <div style="margin-top: 1rem;">
        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Styl pionk√≥w</label>
        <div class="piece-selector">
          <div class="piece-option active" onclick="changePieceStyle('unicode')" data-style="unicode">‚ôî</div>
          <div class="piece-option" onclick="changePieceStyle('text')" data-style="text">K</div>
          <div class="piece-option" onclick="changePieceStyle('minimal')" data-style="minimal">‚óè</div>
        </div>
      </div>
      
      <div class="setting-item">
        <span>D≈∫wiƒôki</span>
        <label class="toggle-switch">
          <input type="checkbox" id="soundToggle" checked onchange="toggleSound()">
          <span class="slider"></span>
        </label>
      </div>
      
      <div class="setting-item">
        <span>Pod≈õwietlanie ruch√≥w</span>
        <label class="toggle-switch">
          <input type="checkbox" id="highlightMoves" checked onchange="toggleHighlight()">
          <span class="slider"></span>
        </label>
      </div>
    </div>
    
  </div>
  
</div>

<div class="feedback" id="feedback">
  <span id="feedbackText">≈öwietny ruch!</span>
</div>

<div class="modal" id="successModal">
  <div class="modal-content">
    <div style="font-size: 4rem;">üéâ</div>
    <h2 class="modal-title">Gratulacje!</h2>
    <p style="margin: 1rem 0;">RozwiƒÖza≈Çe≈õ zadanie poprawnie!</p>
    
    <div class="modal-stats">
      <div>
        <div class="modal-stat-value" id="modalTime">0:00</div>
        <div style="font-size: 0.85rem; color: #666;">Czas</div>
      </div>
      <div>
        <div class="modal-stat-value" id="modalMoves">0</div>
        <div style="font-size: 0.85rem; color: #666;">Ruchy</div>
      </div>
      <div>
        <div class="modal-stat-value" id="modalRating">+10</div>
        <div style="font-size: 0.85rem; color: #666;">Rating</div>
      </div>
    </div>
    
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">Zamknij</button>
      <button class="btn btn-success" onclick="nextPuzzle()">Nastƒôpne ‚Üí</button>
    </div>
  </div>
</div>

<script>
const PIECE_STYLES = {
  unicode: {
    wK: '‚ôî', wQ: '‚ôï', wR: '‚ôñ', wB: '‚ôó', wN: '‚ôò', wP: '‚ôô',
    bK: '‚ôö', bQ: '‚ôõ', bR: '‚ôú', bB: '‚ôù', bN: '‚ôû', bP: '‚ôü'
  },
  text: {
    wK: 'K', wQ: 'Q', wR: 'R', wB: 'B', wN: 'N', wP: 'P',
    bK: 'k', bQ: 'q', bR: 'r', bB: 'b', bN: 'n', bP: 'p'
  },
  minimal: {
    wK: '‚óâ', wQ: '‚óà', wR: '‚ñ£', wB: '‚óÜ', wN: '‚ó≠', wP: '‚óã',
    bK: '‚óè', bQ: '‚óÜ', bR: '‚ñ†', bB: '‚óá', bN: '‚óÆ', bP: '‚óè'
  }
};

let currentPieceStyle = 'unicode';
let PIECES = PIECE_STYLES.unicode;

const FILES = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
const RANKS = ['8', '7', '6', '5', '4', '3', '2', '1'];

const PUZZLES = [
  {
    id: 1,
    title: "Bia≈Çe zaczynajƒÖ i wygrywajƒÖ",
    difficulty: "easy",
    rating: 1200,
    position: { 
      c8: 'bR', e7: 'bQ', a6: 'bP', f6: 'bP', g6: 'bQ', h7: 'bP', g8: 'bK',
      a2: 'wP', b2: 'wP', f2: 'wP', g2: 'wP', h3: 'wR', g1: 'wK'
    },
    solution: ['Rh8'],
    explanation: "Wie≈ºa h3-h8 daje mata."
  },
  {
    id: 2,
    title: "Bia≈Çe zaczynajƒÖ i wygrywajƒÖ",
    difficulty: "medium",
    rating: 1400,
    position: {
      a6: 'bP', c5: 'bP', e5: 'bP', f5: 'bP', e6: 'bK',
      a4: 'wP', c4: 'wP', f4: 'wP', c3: 'wP', e3: 'wP', d3: 'wK'
    },
    solution: ['fxe4'],
    explanation: "Bia≈Çe wygrywajƒÖ poprzez fxe4."
  },
  {
    id: 3,
    title: "Bia≈Çe zaczynajƒÖ i wygrywajƒÖ",
    difficulty: "hard",
    rating: 1600,
    position: {
      a6: 'bP', h6: 'bP', c4: 'bP', f6: 'bR', c5: 'bP', e5: 'bP', d5: 'wK',
      a3: 'wP', e3: 'wR', f3: 'wP', b3: 'wR', g3: 'wP', h2: 'wP', g2: 'wP'
    },
    solution: ['Ra5'],
    explanation: "Wie≈ºa a5 wygrywajƒÖcym ruchem."
  },
  {
    id: 4,
    title: "Bia≈Çe zaczynajƒÖ i wygrywajƒÖ",
    difficulty: "hard",
    rating: 1700,
    position: {
      a7: 'wR', e8: 'bR', a6: 'bP', g6: 'bP', h5: 'bP', e5: 'bP', f5: 'bP', b4: 'bP',
      a3: 'wR', b3: 'wK', f3: 'wP', f2: 'wP', g2: 'wP'
    },
    solution: ['a5', 'd4', 'e4', 'd5', 'fxe4'],
    explanation: "Sekwencja ruch√≥w prowadzƒÖca do wygranej."
  }
];

let currentPuzzleIndex = 0;
let currentPosition = {};
let selectedSquare = null;
let moveHistory = [];
let solutionIndex = 0;
let timerInterval = null;
let startTime = 0;
let elapsedTime = 0;
let soundEnabled = true;
let highlightEnabled = true;

let userStats = {
  rating: 1200,
  totalSolved: 0,
  totalAttempts: 0,
  currentStreak: 0,
  bestStreak: 0,
  accuracyPercent: 0,
  averageTime: 0
};

function init() {
  loadSettings();
  loadPuzzle(currentPuzzleIndex);
  updateStatsDisplay();
}

function loadSettings() {
  const darkMode = localStorage.getItem('darkMode') === 'true';
  const theme = localStorage.getItem('boardTheme') || 'classic';
  const pieceStyle = localStorage.getItem('pieceStyle') || 'unicode';
  
  if (darkMode) {
    document.body.classList.add('dark-mode');
    document.getElementById('darkModeToggle').checked = true;
  }
  
  changeTheme(theme);
  changePieceStyle(pieceStyle);
}

function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  localStorage.setItem('darkMode', isDark);
}

function changeTheme(theme) {
  document.body.className = document.body.className.replace(/theme-\w+/g, '');
  if (theme !== 'classic') {
    document.body.classList.add(`theme-${theme}`);
  }
  
  document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
  document.querySelector(`.theme-${theme}`).classList.add('active');
  
  localStorage.setItem('boardTheme', theme);
}

function changePieceStyle(style) {
  currentPieceStyle = style;
  PIECES = PIECE_STYLES[style];
  
  document.querySelectorAll('.piece-option').forEach(opt => opt.classList.remove('active'));
  document.querySelector(`[data-style="${style}"]`).classList.add('active');
  
  localStorage.setItem('pieceStyle', style);
  renderBoard();
}

function toggleSound() {
  soundEnabled = document.getElementById('soundToggle').checked;
}

function toggleHighlight() {
  highlightEnabled = document.getElementById('highlightMoves').checked;
}

function renderBoard() {
  const board = document.getElementById('chessBoard');
  board.innerHTML = '';
  
  RANKS.forEach((rank, rankIdx) => {
    FILES.forEach((file, fileIdx) => {
      const square = document.createElement('div');
      const isLight = (rankIdx + fileIdx) % 2 === 0;
      const squareId = file + rank;
      
      square.className = `square ${isLight ? 'light' : 'dark'}`;
      square.dataset.square = squareId;
      
      if (currentPosition[squareId]) {
        const piece = document.createElement('div');
        piece.className = 'piece';
        piece.textContent = PIECES[currentPosition[squareId]];
        square.appendChild(piece);
      }
      
      square.addEventListener('click', handleSquareClick);
      board.appendChild(square);
    });
  });
  
  highlightLastMove();
}

function highlightLastMove() {
  if (moveHistory.length > 0 && highlightEnabled) {
    const lastMove = moveHistory[moveHistory.length - 1];
    const fromSquare = document.querySelector(`[data-square="${lastMove.from}"]`);
    const toSquare = document.querySelector(`[data-square="${lastMove.to}"]`);
    
    if (fromSquare) fromSquare.classList.add('last-move');
    if (to```html
Square) toSquare.classList.add('last-move');
  }
}

function loadPuzzle(index) {
  if (index < 0 || index >= PUZZLES.length) return;
  
  currentPuzzleIndex = index;
  const puzzle = PUZZLES[index];
  
  currentPosition = { ...puzzle.position };
  selectedSquare = null;
  moveHistory = [];
  solutionIndex = 0;
  elapsedTime = 0;
  
  document.getElementById('puzzleTitle').textContent = puzzle.title;
  document.getElementById('difficultyText').textContent = 
    puzzle.difficulty.charAt(0).toUpperCase() + puzzle.difficulty.slice(1);
  document.getElementById('difficultyBadge').className = `difficulty-badge ${puzzle.difficulty}`;
  document.getElementById('puzzleRating').textContent = puzzle.rating;
  document.getElementById('totalMoves').textContent = puzzle.solution.length;
  document.getElementById('currentMove').textContent = 0;
  
  renderBoard();
  startTimer();
  updateMovesDisplay();
}

function startTimer() {
  stopTimer();
  startTime = Date.now();
  timerInterval = setInterval(() => {
    elapsedTime = Math.floor((Date.now() - startTime) / 1000);
    document.getElementById('timerDisplay').textContent = formatTime(elapsedTime);
  }, 1000);
}

function stopTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function handleSquareClick(e) {
  const square = e.currentTarget;
  const squareId = square.dataset.square;
  
  if (selectedSquare) {
    attemptMove(selectedSquare, squareId);
    clearSelection();
  } else if (currentPosition[squareId]) {
    selectSquare(squareId);
  }
}

function getLegalMoves(from, piece) {
  const moves = [];
  const [file, rank] = [from[0], from[1]];
  const fileIdx = FILES.indexOf(file);
  const rankIdx = RANKS.indexOf(rank);
  const isWhite = piece[0] === 'w';
  const pieceType = piece[1];
  
  const addMove = (f, r) => {
    if (f >= 0 && f < 8 && r >= 0 && r < 8) {
      const target = FILES[f] + RANKS[r];
      const targetPiece = currentPosition[target];
      if (!targetPiece || targetPiece[0] !== piece[0]) {
        moves.push(target);
      }
      return !targetPiece;
    }
    return false;
  };
  
  switch(pieceType) {
    case 'P':
      const direction = isWhite ? -1 : 1;
      const nextRank = rankIdx + direction;
      if (nextRank >= 0 && nextRank < 8) {
        const forward = FILES[fileIdx] + RANKS[nextRank];
        if (!currentPosition[forward]) {
          moves.push(forward);
          const startRank = isWhite ? 6 : 1;
          if (rankIdx === startRank) {
            const twoForward = FILES[fileIdx] + RANKS[nextRank + direction];
            if (!currentPosition[twoForward]) moves.push(twoForward);
          }
        }
        [-1, 1].forEach(df => {
          if (fileIdx + df >= 0 && fileIdx + df < 8) {
            const diag = FILES[fileIdx + df] + RANKS[nextRank];
            if (currentPosition[diag] && currentPosition[diag][0] !== piece[0]) {
              moves.push(diag);
            }
          }
        });
      }
      break;
      
    case 'N':
      [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]].forEach(([df, dr]) => {
        addMove(fileIdx + df, rankIdx + dr);
      });
      break;
      
    case 'B':
      [[-1,-1],[-1,1],[1,-1],[1,1]].forEach(([df, dr]) => {
        let f = fileIdx + df, r = rankIdx + dr;
        while (addMove(f, r)) {
          f += df;
          r += dr;
        }
      });
      break;
      
    case 'R':
      [[0,-1],[0,1],[-1,0],[1,0]].forEach(([df, dr]) => {
        let f = fileIdx + df, r = rankIdx + dr;
        while (addMove(f, r)) {
          f += df;
          r += dr;
        }
      });
      break;
      
    case 'Q':
      [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(([df, dr]) => {
        let f = fileIdx + df, r = rankIdx + dr;
        while (addMove(f, r)) {
          f += df;
          r += dr;
        }
      });
      break;
      
    case 'K':
      [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(([df, dr]) => {
        addMove(fileIdx + df, rankIdx + dr);
      });
      break;
  }
  
  return moves;
}

function selectSquare(squareId) {
  clearSelection();
  selectedSquare = squareId;
  
  const square = document.querySelector(`[data-square="${squareId}"]`);
  if (square) {
    square.classList.add('selected');
    if (highlightEnabled) {
      const piece = currentPosition[squareId];
      if (piece) {
        const legalMoves = getLegalMoves(squareId, piece);
        legalMoves.forEach(move => {
          const sq = document.querySelector(`[data-square="${move}"]`);
          if (sq) sq.classList.add('legal-move');
        });
      }
    }
  }
}

function clearSelection() {
  document.querySelectorAll('.square').forEach(sq => {
    sq.classList.remove('selected', 'legal-move');
  });
  selectedSquare = null;
}

function attemptMove(from, to) {
  const piece = currentPosition[from];
  if (!piece) return;
  
  const legalMoves = getLegalMoves(from, piece);
  if (!legalMoves.includes(to)) {
    showFeedback('Niedozwolony ruch dla tej figury!', 'error');
    return;
  }
  
  const puzzle = PUZZLES[currentPuzzleIndex];
  const moveNotation = from + to;
  const expectedMove = puzzle.solution[solutionIndex];
  
  const isCorrect = expectedMove.includes(to) || 
                    moveNotation === expectedMove ||
                    expectedMove.endsWith(to);
  
  makeMove(from, to);
  userStats.totalAttempts++;
  
  if (isCorrect) {
    solutionIndex++;
    
    if (solutionIndex >= puzzle.solution.length) {
      setTimeout(() => puzzleSolved(), 500);
    } else {
      showFeedback('≈öwietny ruch! ‚úì', 'success');
      updateMovesDisplay();
    }
  } else {
    showFeedback('Ruch legalny, ale nie prowadzi do rozwiƒÖzania', 'info');
    updateMovesDisplay();
  }
}

function makeMove(from, to) {
  const piece = currentPosition[from];
  const capture = currentPosition[to];
  
  moveHistory.push({ from, to, piece, capture });
  
  currentPosition[to] = piece;
  delete currentPosition[from];
  
  renderBoard();
  updateMovesHistory();
}

function undoMove() {
  if (moveHistory.length === 0) return;
  
  const lastMove = moveHistory.pop();
  currentPosition[lastMove.from] = lastMove.piece;
  
  if (lastMove.capture) {
    currentPosition[lastMove.to] = lastMove.capture;
  } else {
    delete currentPosition[lastMove.to];
  }
  
  if (solutionIndex > 0) solutionIndex--;
  
  renderBoard();
  updateMovesHistory();
  updateMovesDisplay();
  showFeedback('Ruch cofniƒôty', 'info');
}

function puzzleSolved() {
  stopTimer();
  
  const puzzle = PUZZLES[currentPuzzleIndex];
  const ratingChange = Math.min(20, 15);
  
  userStats.totalSolved++;
  userStats.currentStreak++;
  userStats.rating += ratingChange;
  
  if (userStats.currentStreak > userStats.bestStreak) {
    userStats.bestStreak = userStats.currentStreak;
  }
  
  userStats.accuracyPercent = Math.round(
    (userStats.totalSolved / Math.max(1, userStats.totalAttempts)) * 100
  );
  
  const totalTime = (userStats.averageTime * (userStats.totalSolved - 1) + elapsedTime) / userStats.totalSolved;
  userStats.averageTime = totalTime;
  
  updateStatsDisplay();
  
  document.getElementById('modalTime').textContent = formatTime(elapsedTime);
  document.getElementById('modalMoves').textContent = moveHistory.length;
  document.getElementById('modalRating').textContent = `+${ratingChange}`;
  document.getElementById('successModal').classList.add('visible');
}

function updateStatsDisplay() {
  document.getElementById('userRating').textContent = userStats.rating;
  document.getElementById('userStreak').textContent = userStats.currentStreak;
  document.getElementById('totalSolved').textContent = userStats.totalSolved;
  document.getElementById('bestStreak').textContent = userStats.bestStreak;
  document.getElementById('accuracyPercent').textContent = userStats.accuracyPercent;
  document.getElementById('averageTime').textContent = formatTime(Math.floor(userStats.averageTime));
}

function updateMovesDisplay() {
  document.getElementById('currentMove').textContent = solutionIndex;
}

function updateMovesHistory() {
  const list = document.getElementById('movesList');
  if (moveHistory.length === 0) {
    list.innerHTML = '<div style="text-align: center; color: #999; padding: 2rem;">Brak ruch√≥w</div>';
    return;
  }
  
  list.innerHTML = moveHistory.map((move, idx) => `
    <div class="move-item">
      <span>${idx + 1}.</span>
      <span class="move-notation">${move.from}-${move.to}</span>
    </div>
  `).join('');
}

function showHint() {
  const puzzle = PUZZLES[currentPuzzleIndex];
  if (solutionIndex < puzzle.solution.length) {
    const hint = puzzle.solution[solutionIndex];
    showFeedback(`Podpowied≈∫: Spr√≥buj ${hint}`, 'info');
  }
}

function showFeedback(text, type) {
  const feedback = document.getElementById('feedback');
  document.getElementById('feedbackText').textContent = text;
  feedback.className = `feedback ${type} visible`;
  
  setTimeout(() => {
    feedback.classList.remove('visible');
  }, 3000);
}

function nextPuzzle() {
  closeModal();
  if (currentPuzzleIndex < PUZZLES.length - 1) {
    loadPuzzle(currentPuzzleIndex + 1);
  } else {
    showFeedback('Uko≈Ñczy≈Çe≈õ wszystkie zadania! üéâ', 'success');
    loadPuzzle(0);
  }
}

function resetPuzzle() {
  loadPuzzle(currentPuzzleIndex);
  showFeedback('Zadanie zresetowane', 'info');
}

function closeModal() {
  document.getElementById('successModal').classList.remove('visible');
}

window.onload = init;
</script>

</body>
</html>
```
